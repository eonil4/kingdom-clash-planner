# =========================================================================
# Kingdom Clash Planner - Docker Compose for Local Development
# =========================================================================
# Compatible with Docker Desktop, Rancher Desktop, and Podman
#
# Usage:
#   Development:  docker compose up dev
#   Production:   docker compose up prod
#   Testing:      docker compose run --rm test-unit
#   E2E Tests:    docker compose run --rm test-e2e

services:
  # -------------------------------------------------------------------------
  # Development Server with Hot Reload
  # -------------------------------------------------------------------------
  dev:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: kcp-dev
    ports:
      - "3000:3000"
      - "51204:51204"
    volumes:
      - .:/app:cached
      - node_modules:/app/node_modules
      - pnpm_store:/home/node/.local/share/pnpm/store
    environment:
      - NODE_ENV=development
      - CHOKIDAR_USEPOLLING=true
      - CI=true
    command: sh -c "pnpm install && pnpm run dev --host 0.0.0.0"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # -------------------------------------------------------------------------
  # Development App Service (for VS Code Dev Containers)
  # -------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: kcp-app
    volumes:
      - .:/app:cached
      - node_modules:/app/node_modules
      - pnpm_store:/home/node/.local/share/pnpm/store
    environment:
      - NODE_ENV=development
    tty: true
    stdin_open: true

  # -------------------------------------------------------------------------
  # Production Build
  # -------------------------------------------------------------------------
  prod:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: kcp-prod
    ports:
      - "8080:80"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  # -------------------------------------------------------------------------
  # Unit Tests
  # -------------------------------------------------------------------------
  test-unit:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: kcp-test-unit
    volumes:
      - .:/app:cached
      - node_modules:/app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
    command: pnpm run test:unit:coverage
    profiles:
      - test

  # -------------------------------------------------------------------------
  # Unit Tests with Watch Mode
  # -------------------------------------------------------------------------
  test-unit-watch:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: kcp-test-unit-watch
    ports:
      - "51204:51204"
    volumes:
      - .:/app:cached
      - node_modules:/app/node_modules
    environment:
      - NODE_ENV=test
    command: pnpm run test:unit:coverage:ui:watch
    profiles:
      - test

  # -------------------------------------------------------------------------
  # E2E Tests with Playwright
  # -------------------------------------------------------------------------
  test-e2e:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: kcp-test-e2e
    volumes:
      - .:/app:cached
      - node_modules:/app/node_modules
      - ./playwright-report:/app/playwright-report
      - ./tests/e2e/reports:/app/tests/e2e/reports
    environment:
      - NODE_ENV=test
      - CI=true
      - PLAYWRIGHT_CHROMIUM_EXECUTABLE_PATH=/usr/bin/chromium-browser
    command: pnpm run test:e2e
    depends_on:
      dev:
        condition: service_healthy
    profiles:
      - test

  # -------------------------------------------------------------------------
  # Lint Check
  # -------------------------------------------------------------------------
  lint:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: kcp-lint
    volumes:
      - .:/app:cached
      - node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
    command: pnpm run lint
    profiles:
      - ci

  # -------------------------------------------------------------------------
  # Full CI Pipeline
  # -------------------------------------------------------------------------
  ci:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: kcp-ci
    volumes:
      - .:/app:cached
      - node_modules:/app/node_modules
    environment:
      - NODE_ENV=test
      - CI=true
    command: pnpm run ci
    profiles:
      - ci

volumes:
  node_modules:
    driver: local
  pnpm_store:
    driver: local

networks:
  default:
    name: kcp-network
